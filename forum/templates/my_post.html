<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>title</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container">
      <div class="row" style="width: fit-content">
        <div class="col-sm">
          <h3 class="mb-3 text-primary">{{username}}</h3>
          <a href="/">Home</a>
          <a href="/mypost">My Post</a>
        </div>
        <div class="col-md-auto">
          <div id="posts">
            <h1>My Post</h1>
            {% for post in posts %}
            <div class="card mb-3 shadow-sm bg-light border-primary">
                <div class="card-body">
                  <h5 class="card-title text-primary">{{post.title}}</h5>
                  {% if post.image %}
                  <img
                    src="{{ post.image.url }}"
                    class="card-img-top w-50 h-50 img-fluid img-thumbnail"
                    alt="{{post.fields.title}}"
                  />
                  {% endif %}
                  <h6 class="card-subtitle mb-2 text-muted">
                    Posted by {{username}} on {{post.date_added}}
                  </h6>
                  <p class="card-text">{{post.text}}</p>
                  <button type="submit" class="btn btn-danger mt-3">
                    <i class="bi bi-trash-fill"></i> Delete Post
                  </button>
                  <a href="{% url 'main:show_post' post.pk %}">See Post</a>
                </div>
              </div>
              {% endfor %}
          </div>
          <a href="{% url 'main:logout' %}" class="btn btn-secondary"
            ><i class="bi bi-box-arrow-right"></i> Logout</a
          >
        </div>
        <div class="col-sm-5"></div>
      </div>
    </div>

    <!-- Your scripts here -->
    <script>
      async function getPosts(user_id) {
        return fetch(`get-post/${user_id}`).then((res) => res.json());
      }
      async function getCommentsById(post_id) {
        return fetch(`get-comment/${post_id}`).then((res) => res.json());
      }
      async function getUserById(user_id) {
        return fetch(`get-user/${user_id}`).then((res) => res.json());
      }
      async function refreshPosts() {
        const user_id = "{{ user_id }}";
        const posts = await getPosts(user_id);
        posts.sort(
          (a, b) =>
            new Date(b.fields.date_added) - new Date(a.fields.date_added)
        );
        const htmlStrings = [];
        for (const post of posts) {
          let user = await getUserById(post.fields.user);
          let htmlString = `
                        <div class="card mb-3 shadow-sm bg-light border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${post.fields.title}</h5>`;
          if (post.fields.image) {
            htmlString += `<img src="media/${post.fields.image}" class="card-img-top w-50 h-50 img-fluid img-thumbnail" alt="${post.fields.title}">`;
          }
          htmlString += `<h6 class="card-subtitle mb-2 text-muted">Posted by ${user[0].fields.username} on ${post.fields.date_added}</h6>
                                <p class="card-text">${post.fields.text}</p>`;
          if (post.fields.user == user_id) {
            htmlString += `
                        <button type="submit" onclick="deletePost(${post.pk}); return false;" class="btn btn-danger mt-3"><i class="bi bi-trash-fill"></i> Delete Post</button>`;
          }
          htmlString += `
                    <a href = "post/${post.pk}">See Post</a>
                        </div>
                        </div>`;
          htmlStrings.push(htmlString);
        }

        document.getElementById("posts").innerHTML = htmlStrings.join("");
      }
      // refreshPosts();

      function addPost() {
        fetch("{% url 'main:create_post' %}", {
          method: "POST",
          body: new FormData(document.querySelector("#form-post")),
        }).then(refreshPosts);

        document.getElementById("form-post").reset();
        return false;
      }
      function addComment(post_id) {
        console.log("adding comment");
        fetch(`create-comment/${post_id}/`, {
          method: "POST",
          body: new FormData(document.querySelector("#form-comment")),
        }).then(refreshPosts);

        document.getElementById("form-comment").reset();
        return false;
      }

      function deletePost(post_id) {
        fetch(`delete-post/${post_id}`, {
          method: "DELETE",
        }).then(refreshPosts);
        return false;
      }

      function deleteComment(comment) {
        console.log("deleteComment");
        fetch(`delete-comment/${comment}`, {
          method: "DELETE",
        }).then(refreshPosts);
        return false;
      }
      // document.getElementById("button_add").onclick = addPost;
    </script>
  </body>
</html>
